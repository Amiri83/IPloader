#! /usr/bin/env python
import os
from os import path
from iploader.compare import Compare
from iploader.database import DB
from iploader.readConfig import Reader
import logging


def main():
    
    read = Reader()
    try:
        logging.basicConfig(filename=read.log_destination,
                            filemode='a', format='%(asctime)s- %(levelname)s - %(message)s',
                            datefmt='%d-%b-%y %H:%M:%S',
                            level=logging.INFO)
        compare = Compare()
        db = DB()
        logging.info("========== Started ==============")
        print("========== Started ==============")

        result = compare.do_compare(read.infile)
        abuse_list = []
        if result is not None:
            db.insert_data(result)
        else:
            logging.info("No new IP found")
            print("No new IP found")
        try:
            if int(read.expiration_days) != 0:
                if path.exists(read.infile):
                    expired_ips = (compare.get_expired_ips())
                    final_ips = compare.do_compare_expire(expired_ips)
                    with open(read.outfile, "w") as f:
                        for final_ip in final_ips:
                            f.write("%s\n" % final_ip)
            else:
                print("IP expiration date set to NeverExpire")
                logging.info("IP expiration date set to NeverExpire")
        except BaseException as exp:
            logging.error(f"{exp}")

    except BaseException as exp:
        print(exp)
        print(type(exp))

    print("=========== Finished ============")
    logging.info("=========== Finished ============")


if __name__ == '__main__':
    main()
